services:
  # Fleetbase API Web Service
  - type: web
    name: fleetbase-api
    env: docker
    dockerContext: .
    dockerfilePath: docker/Dockerfile
    plan: starter
    region: singapore
    healthCheckPath: /
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: fleetbase-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: fleetbase-cache
          property: connectionString
      - key: QUEUE_CONNECTION
        value: redis
      - key: CACHE_DRIVER
        value: redis
      - key: BROADCAST_DRIVER
        value: socketcluster
      - key: APP_URL
        fromService:
          type: web
          name: fleetbase-api
          property: host
      - key: SESSION_DOMAIN
        fromService:
          type: web
          name: fleetbase-api
          property: host
      - key: LOG_CHANNEL
        value: stdout
      - key: ENVIRONMENT
        value: production

  # Fleetbase Console Web Service
  - type: web
    name: fleetbase-console
    env: docker
    dockerContext: console
    dockerfilePath: console/Dockerfile
    plan: starter
    region: singapore
    envVars:
      - key: API_HOST
        fromService:
          type: web
          name: fleetbase-api
          property: host

  # Queue Worker
  - type: worker
    name: fleetbase-queue
    env: docker
    dockerContext: .
    dockerfilePath: docker/Dockerfile
    dockerCommand: "php artisan queue:work"
    plan: starter
    region: singapore
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: fleetbase-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: fleetbase-cache
          property: connectionString
      - key: QUEUE_CONNECTION
        value: redis

  # Scheduler
  - type: worker
    name: fleetbase-scheduler
    env: docker
    dockerContext: .
    dockerfilePath: docker/Dockerfile
    dockerCommand: "go-crond --verbose root:./crontab"
    plan: starter
    region: singapore
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: fleetbase-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: keyvalue
          name: fleetbase-cache
          property: connectionString

  # SocketCluster (Private Service)
  - type: pserv
    name: fleetbase-socket
    env: image
    image:
      url: socketcluster/socketcluster:v17.4.0
    plan: starter
    region: singapore
    envVars:
      - key: SOCKETCLUSTER_WORKERS
        value: 1
      - key: SOCKETCLUSTER_BROKERS
        value: 1

  # Managed Key Value (Redis Replacement)
  - type: keyvalue
    name: fleetbase-cache
    plan: starter
    region: singapore
    ipAllowList: []

databases:
  - name: fleetbase-db
    databaseName: fleetbase
    user: fleetbase
    plan: starter
    region: singapore
